<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAssembly Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #terminal-container {
            width: 100%;
            height: 100%;
            background: black;
        }
        #launch-button {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="launch-button">Launch Shell</button>
    <div id="terminal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-pty@0.9.4/index.js"></script>
    <script>
        // Configuration
        const wasmConfig = {
            baseUrl: location.origin + "/container2wasm-demo",
            containerPath: "/containers/amd64-debian-wasi-container",
            chunks: 5
        };

        // Worker code
        const workerCode = `
            importScripts("https://cdn.jsdelivr.net/npm/xterm-pty@0.9.4/workerTools.js");

            let wasmModule;
            let loadedChunks = 0;

            self.onmessage = async function(e) {
                if (e.data.type === "init") {
                    const { wasmUrl, chunks } = e.data;
                    console.log("Loading WebAssembly from", wasmUrl, "in", chunks, "chunks");
                    
                    for (let i = 0; i < chunks; i++) {
                        const chunkUrl = \`\${wasmUrl}/\${i}\`;
                        const response = await fetch(chunkUrl);
                        const buffer = await response.arrayBuffer();
                        // Here you would accumulate the chunks
                        // This is a placeholder and needs to be implemented based on container2wasm
                        console.log(\`Loaded chunk \${i + 1} of \${chunks}\`);
                        loadedChunks++;
                    }

                    if (loadedChunks === chunks) {
                        // Here you would instantiate the WebAssembly module
                        // This is a placeholder
                        console.log("All chunks loaded, instantiating WebAssembly module");
                        wasmModule = { exports: { run: (cmd) => \`Executed: \${cmd}\` } };
                        self.postMessage({type: "ready"});
                    }
                } else if (e.data.type === "run") {
                    if (!wasmModule) {
                        self.postMessage({type: "error", message: "WebAssembly module not initialized"});
                        return;
                    }
                    // Execute command in the WebAssembly environment
                    const result = wasmModule.exports.run(e.data.input);
                    self.postMessage({type: "done", data: result});
                }
            };
        `;

        const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(workerBlob);

        let term, worker;

        function getWasmUrl() {
            return wasmConfig.baseUrl + wasmConfig.containerPath;
        }

        function startWasi(elemId, wasmUrl, chunks) {
            term = new Terminal({
                cursorBlink: true,
                theme: {
                    background: '#000',
                    foreground: '#fff'
                }
            });
        
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
        
            term.open(document.getElementById(elemId));
            fitAddon.fit();
        
            window.addEventListener('resize', () => fitAddon.fit());
        
            const { master, slave } = openpty();
            term.loadAddon(master);
        
            worker = new Worker(workerUrl);
        
            let currentLine = '';
        
            worker.onmessage = function(e) {
                if (e.data.type === "ready") {
                    console.log("WebAssembly module ready");
                    term.write("WebAssembly shell ready. Type commands:\r\n$ ");
                } else if (e.data.type === "done") {
                    console.log("Command execution complete:", e.data.data);
                    term.write(e.data.data + "\r\n$ ");
                    currentLine = '';
                } else if (e.data.type === "error") {
                    console.error("Error:", e.data.message);
                    term.write("Error: " + e.data.message + "\r\n$ ");
                    currentLine = '';
                }
            };
        
            worker.postMessage({
                type: "init", 
                wasmUrl: wasmUrl,
                chunks: chunks
            });
        
            new TtyServer(slave).start(worker);
        
            term.onData(data => {
                switch (data) {
                    case '\r': // Enter
                        term.write('\r\n');
                        if (currentLine.trim().length > 0) {
                            worker.postMessage({type: "run", input: currentLine.trim()});
                        } else {
                            term.write('$ ');
                        }
                        currentLine = '';
                        break;
                    case '\u007F': // Backspace
                        if (currentLine.length > 0) {
                            currentLine = currentLine.slice(0, -1);
                            term.write('\b \b');
                        }
                        break;
                    default:
                        currentLine += data;
                        term.write(data);
                }
            });
        }

        document.getElementById('launch-button').addEventListener('click', function() {
            this.style.display = 'none';
            startWasi('terminal-container', getWasmUrl(), wasmConfig.chunks);
        });
    </script>
</body>
</html>