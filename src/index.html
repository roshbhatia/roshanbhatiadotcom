<html>
  <head>
    <title>Web Terminal -- roshanbhatiadotcom</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.17.0/css/xterm.css">
    <style>
      body {
        background-color: #1e1e1e;
        color: #ffffff;
        font-family: 'Fira Code', monospace;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      #loading {
        font-size: 24px;
        white-space: nowrap;
        overflow: hidden;
        border-right: 0.15em solid orange;
        animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
      }

      @keyframes typing {
        from { width: 0 }
        to { width: 100% }
      }

      @keyframes blink-caret {
        from, to { border-color: transparent }
        50% { border-color: orange }
      }

      #terminal {
        width: 100%;
        height: 100%;
        border: 2px solid #4caf50;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        background-color: #000000;
      }

      .xterm {
        font-family: 'Fira Code', monospace;
        font-size: 1rem; /* Default font size */
        color: #ffffff;
        width: 100%;
        height: 100%;
      }

      .xterm .xterm-viewport {
        background-color: #000000;
      }

      .xterm .xterm-screen {
        background-color: #000000;
      }

      .xterm .xterm-cursor {
        border-left: 2px solid #4caf50;
      }

      .xterm .xterm-helpers {
        z-index: 5;
      }

      .xterm .xterm-helper-textarea {
        opacity: 0;
      }

      .xterm .composition-view {
        background: #000;
        color: #FFF;
      }
    </style>
  </head>
  <body>
    <div id="loading">Web Terminal Loading...</div>
    <div id="terminal"></div>
    <script src="https://cdn.jsdelivr.net/npm/xterm@4.17.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-pty@0.9.4/index.js"></script>
    <script src="./stack.js"></script>
    <script src="./ws-delegate.js"></script>
    <script>
      function showTerminal() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('terminal').style.display = 'block';

        const xterm = new Terminal();
        xterm.open(document.getElementById("terminal"));

        const { master, slave } = openpty();

        termios = slave.ioctl("TCGETS");
        termios.iflag &= ~(/*IGNBRK | BRKINT | PARMRK |*/ ISTRIP | INLCR | IGNCR | ICRNL | IXON);
        termios.oflag &= ~(OPOST);
        termios.lflag &= ~(ECHO | ECHONL | ICANON | ISIG | IEXTEN);
        //termios.cflag &= ~(CSIZE | PARENB);
        //termios.cflag |= CS8;
        slave.ioctl("TCSETS", new Termios(termios.iflag, termios.oflag, termios.cflag, termios.lflag, termios.cc));
        xterm.loadAddon(master);
        const worker = new Worker("./worker.js"+location.search);

        var nwStack;
        var netParam = getNetParam();
        var workerImage = "./out.wasm";
        if (netParam) {
            if (netParam.mode == 'delegate') {
                nwStack = delegate(worker, workerImage, netParam.param);
            } else if (netParam.mode == 'browser') {
                nwStack = newStack(worker, workerImage, new Worker("./stack-worker.js"+location.search), location.origin + "/c2w-net-proxy.wasm");
            }
        }
        if (!nwStack) {
            worker.postMessage({type: "init", imagename: workerImage});
        }
        new TtyServer(slave).start(worker, nwStack);

        function getNetParam() {
            var vars = location.search.substring(1).split('&');
            for (var i = 0; i < vars.length; i++) {
                var kv = vars[i].split('=');
                if (decodeURIComponent(kv[0]) == 'net') {
                    return {
                        mode: kv[1],
                        param: kv[2],
                    };
                }
            }
            return null;
        }

        // Adjust terminal size and font size on window resize
        function resizeTerminal() {
          const terminalElement = document.getElementById('terminal');
          const width = terminalElement.clientWidth;
          const height = terminalElement.clientHeight;
          const fontSize = Math.max(Math.min(width, height) / 50, 10); // Adjust the divisor for font size scaling
          xterm.setOption('fontSize', fontSize);
          xterm.fit();
        }

        window.addEventListener('resize', resizeTerminal);
        resizeTerminal(); // Initial resize
      }

      // Simulate loading time
      setTimeout(showTerminal, 3500);
    </script>
  </body>
</html>